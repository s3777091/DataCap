from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
import json
import os
import time

def fetch(driver, url):
    try:
        driver.get(url)
        time.sleep(0.5)
        content = driver.page_source
        print(f"Successfully retrieved data from {url}")
        return {"content": content}
    except Exception as e:
        print(f"Failed to retrieve the webpage: {url}. Error: {e}")
        return {"content": ""}

def parse(pr):
    lines = pr["content"].split('\n')
    result_dict = {
        "title": "",
        "role": "user",
        "content": "what is code vulnerable of this code:\n1. Line of code vulnerable:\n2. code vulnerable detail:\n"
    }
    for line in lines:
        if '# Title:' in line or '# Exploit Title:' in line:
            result_dict["title"] = line.split(':', 1)[1].strip() if len(line.split(':', 1)) > 1 else ""
        elif not line.startswith('#') and line.strip():
            result_dict["content"] += line.strip() + "\n"
    return result_dict

def main(start_id, count):
    base_url = "https://www.exploit-db.com/raw/"
    urls = [f"{base_url}{start_id - i}" for i in range(count)]
    data = []

    options = Options()
    options.headless = True  # Run in headless mode
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)

    try:
        for url in urls:
            content = fetch(driver, url)
            if content["content"]:
                data.append(parse(content))
    finally:
        driver.quit()

    os.makedirs("data", exist_ok=True)
    file_name = f"{start_id}-{start_id - count + 1}.json"
    with open(os.path.join("data", file_name), 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)
        time.sleep(0.5)
        time.sleep(0.5)

if __name__ == "__main__":

    start_id = int(30000)
    count = int(5000)
    main(start_id, count)


